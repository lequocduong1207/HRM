services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: hrm-sqlserver
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "Pass@12345678"
      MSSQL_PID: "Express"
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
      - ./init-db.sh:/init-db.sh
    command: /bin/bash -c "(/opt/mssql/bin/sqlservr &) && /bin/bash /init-db.sh && tail -f /dev/null"
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'Pass@12345678' -C -d HRM_DB -Q 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 80s
    networks:
      - hrm-network

  backend:
    build: .
    container_name: hrm-backend
    ports:
      - "5000:5000"
    environment:
      NODE_ENV: production
      DB_HOST: sqlserver
      DB_USER: sa
      DB_PASSWORD: Pass@12345678
      DB_NAME: HRM_DB
      PORT: 5000
      JWT_SECRET: c2c3b06b8e8d91d71ae2a195fd1cfc28aa715bbb3ca4c6ad7ddfa347c14e6332
      JWT_REFRESH_SECRET: a8f5f167f44f4964e6c998dee827110c03f4c1b5c5c2b6c4e6f8a9b5c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0
      JWT_EXPIRES_IN: 30d
      SALT_ROUNDS: 10
    depends_on:
      sqlserver:
        condition: service_healthy
    restart: on-failure
    networks:
      - hrm-network

networks:
  hrm-network:
    driver: bridge

volumes:
  sqlserver_data:
